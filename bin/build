#!/bin/bash
# Compiles and bundles the typescript.
# All arguments are passed to the underlying `tsc` command.

# shellcheck source=./share.sh
_dir="$( dirname "$0" )"
source "${_dir}/share.sh"
unset _dir

PATH="${ROOT}/node_modules/.bin:${PATH}"

function main {
    ( pushd "$ROOT" || exit 1 ) &> /dev/null
    check_installed_tsc
    build_js "$@"
    ( popd || exit 1 ) &> /dev/null
}

# shellcheck disable=SC2155
function check_installed_tsc {
    [ -f "${ROOT}/node_modules/.bin/tsc" ] && return 0

    local tsc_display="$( colored "$COLOR_CODE" "tsc" )"
    local npm_display="$( colored "$COLOR_CODE" "npm" )"

    msg "Warning: ${tsc_display} is not installed."
    if is_available "yarn"; then
        if prompt_question \
            "Install all npm dependencies with ${npm_display}?"
        then
            also_to_stderr=1 try_run \
                "npm install"
        else
            exit 0
        fi
    else
        err "\
${npm_display} is not installed,
cannot automatically install dependencies.
Install ${npm_display} to run this project."
    fi
}

function build_js {
    local args=( "$@" )
    msg "Building JavaScript..."
    tsc-bundle "./tsconfig.json" "${args[@]}"
}

main "$@"
