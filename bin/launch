#!/bin/bash
# Launches a development server with `miniserve`.
# All arguments are passed to the underlying `miniserve` command.
# For example, to start the server on port "9000", use `-p 9000`.
# See `miniserve --help` for more info.

# shellcheck source=./share.sh
_dir="$( dirname "$0" )"
source "${_dir}/share.sh"
unset _dir

function main {
    check_installed_miniserve
    launch_server "$@"
}

# shellcheck disable=SC2155
function check_installed_miniserve {
    is_available "miniserve" && return 0

    local miniserve_display="$( colored "$COLOR_CODE" "miniserve" )"
    local cargo_display="$( colored "$COLOR_CODE" "cargo" )"

    msg "Warning: ${miniserve_display} is not installed."
    if is_available "cargo"; then
        if prompt_question \
            "Install ${miniserve_display} with ${cargo_display}?"
        then
            also_to_stderr=1 try_run \
                "cargo install miniserve --color always"
        else
            exit 0
        fi
    else
        err "\
${cargo_display} is not installed,
cannot automatically install ${miniserve_display}.
Install ${miniserve_display} or ${cargo_display}, then run this script again."
    fi
}

function launch_server {
    local args=( "$@" )
    miniserve "${args[@]}" .
}

main "$@"
